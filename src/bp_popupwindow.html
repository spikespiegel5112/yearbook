<!DOCTYPE html>
<html>

<head lang="en">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="keywords" content="">
	<title>忆尔3.0-书册预览</title>
	<!-- build:css css/all.min.css -->
	<link rel="stylesheet" href="css/reset.css" type="text/css" media="all">
	<link rel="stylesheet" href="css/bookpreview.css" type="text/css" media="all">
	<!-- endbuild -->
</head>

<body>
	<!-- main -->
	<div class="bp_preview_container">
		<div class='book_preview_tite_wrapper'>
			<div class="book_preview_tite">《追忆青春》模板预览模板预览</div>
		</div>
		<div class="flipbook-viewport">
			<div class='flipbook_wrapper' pagecount='19'>
				<a class='flipbook_prevpage_btn' href="javascript:;"></a>
				<div class='flipbook'>
					<div depth="5" class="hard" style="background-image:url('img/default/1.jpg');">
						<link href="http://yb-test-book.qiniudn.com/pageTpl/IMAGE_TEXT/37/css/small_left.css" rel="stylesheet" type="text/css">
						<div class="container_activity_37_small_left">
							<div class="page_header_container">
								<div slottype="article" class="warp1">
									<div class="richShow" slottype="articleShow" textheight="40">
										<div class="main_title" slottype="richText" slotnum="0">
											雄关为头越
										</div>
									</div>
								</div>
							</div>
							<div class="photo0_container">
								<span id="imgMask0" imgwidth="1324" imgheight="907" slotnum="0" slottype="mask" class="photoframe_common_property photoframe0"></span>
								<img slottype="img" slotnum="0" class="img0" src="">
							</div>
							<div class="photo1_container">
								<span id="imgMask1" imgwidth="498" imgheight="334" slotnum="1" slottype="mask" class="photoframe_common_property photoframe1"></span>
								<img slottype="img" slotnum="1" class="img1" src="">
							</div>
							<div class="photo2_container">
								<span id="imgMask2" imgwidth="389" imgheight="261" slotnum="2" slottype="mask" class="photoframe_common_property photoframe2"></span>
								<img slottype="img" slotnum="2" class="img2" src="">
							</div>
							<div class="content_container">
								<strong>
											<div slottype="article" class="warp2">
												<div class="richShow" slottype="articleShow" textheight="30">
													<p></p><p slottype="richText" slotnum="2" style="min-height:30px;" placeholder="活动标题" mode="inline"></p>
													<p></p>
												</div>
											</div>
										</strong>
								<div slottype="article" class="warp3">
									<div class="richShow" slottype="articleShow" textheight="96">
										<p slottype="richText" slotnum="3" style="display:block;word-wrap:break-word;" placeholder="活动内容"></p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div depth="5" class="hard front-side secondcover even" style="background-image:url('img/default/2.jpg');">
						<span class="depth"></span>
						<link href="http://yb-test-book.qiniudn.com/pageTpl/PANO/2/css/small_left.css" rel="stylesheet" type="text/css">
						<div class="container_panoramic_02_small_left">
							<div slottype="article" class="warp">
								<div slottype="articleShow" textheight="62" class="richShow">
									<p placeholder="学校班级.." slottype="richText" slotnum="4" mode="inline" class="graduate-po">
									</p>
								</div>
							</div>
							<span id="imgMask1" imgwidth="3120" imgheight="1700" slotnum="1" slottype="mask" class="photoframe1" style="text-align:center;vertical-align:middle;display: block;"></span>
							<img slottype="img" slotnum="1" src="" class="img1">
						</div>
					</div>
					<div class="hard fixed back-side thirdcover p19" style="background-image:url('img/default/tpl_small.jpg')">
						<span class="depth"></span>
						<link href="http://yb-test-book.qiniudn.com/pageTpl/PANO/2/css/small_right.css" rel="stylesheet" type="text/css">
						<div class="container_panoramic_02_small_right">
							<div slottype="article" class="warp">
								<div slottype="articleShow" textheight="62" class="richShow">
									<p placeholder="学校班级.." slottype="richText" slotnum="4" mode="inline" class="graduate-po">
									</p>
								</div>
							</div>
							<span id="imgMask1" imgwidth="3120" imgheight="1700" slotnum="1" slottype="mask" class="photoframe1" style="text-align:center;vertical-align:middle;display: block;"></span>
							<img slottype="img" slotnum="1" src="" class="img1">
						</div>
					</div>
					<div class="hard p20" style="background-image:url('img/default/tpl_small.jpg')"></div>
				</div>
				<a class='flipbook_nextpage_btn' href="javascript:;"></a>
			</div>
		</div>
	</div>
	<!--底部-->
	<script type="text/javascript" src='assets/js/jquery.min.js'></script>
	<script type="text/javascript" src='assets/js/modernizr.2.5.3.min.js'></script>
	<!-- build:js js/all.js -->
	<script type="text/javascript" src='js/check_os.js'></script>
	<!-- endbuild -->
	<script type="text/javascript">
		function loadApp() {
			//这是指定当前读取的是第几本书册的变量，序号是flipbookpages文件夹里的序号
			var bookIdx = 1;
			var pageWidth = $('.flipbook-viewport .page').width();
			var pageHegiht = $('.flipbook-viewport .page').height();
			var flipbook = $('.flipbook');
			var pageSection = $('.chapter_info ul li');

			// if (flipbook.width() == 0 || flipbook.height() == 0) {
			//     setTimeout(loadApp, 10);
			//     return;
			// }

			flipbook.bind('first', function() {
				$('.page-wrapper[page=1]').find('.p1').addClass('hard');
			})

			//点击章节目录中的章节名称跳转到相应的页面中，章节名称所对应的页面序号在html里用page属性做为标记
			pageSection.click(function() {
				var $this = $(this);
				var pageIndex = $this.attr('page');
				$this.addClass('active').siblings().removeClass('active');
				flipbook.turn('page', pageIndex);
			});

			$(document).keydown(function(e) {
				var previous = 37,
					next = 39;
				switch (e.keyCode) {
					case previous:
						flipbook.turn('previous');
						break;
					case next:
						flipbook.turn('next');
						break;
				}
			});

			IEcss()
			
			flipbook.turn({
				width: 814,
				height: 576,
				elevation: 0,
				acceleration: !isChrome(),
				autoCenter: true,
				gradients: true,
				duration: 1000,
				pages: bookLength(),
				when: {
					turning: function(e, page, view) {
						var book = $(this),
							currentPage = book.turn('page'),
							pages = book.turn('pages');

						// $('.page-wrapper .page').addClass('hard')

						if (currentPage > 3 && currentPage < pages - 3) {
							if (page == 1) {
								book.turn('page', 2).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							} else if (page == pages) {
								book.turn('page', pages - 1).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							}
						} else if (page > 3 && page < pages - 3) {
							if (currentPage == 1) {
								book.turn('page', 2).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							} else if (currentPage == pages) {
								book.turn('page', pages - 1).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							}
						}

						if (page >= 2) {
							$('.flipbook_wrapper .p2').addClass('fixed');
						} else {
							$('.flipbook_wrapper .p2').removeClass('fixed');
						}
						if (page < book.turn('pages')) {
							$('.flipbook_wrapper .p' + (bookLength() - 1)).addClass('fixed');
						} else {
							$('.flipbook_wrapper .p' + (bookLength() - 1)).removeClass('fixed');
						}
						updateDepth(book, page);
						disableControls(page);
					},
					turned: function(e, page, view) {
						var book = $(this);
						updateDepth(book);
						disableControls(page);
						book.turn('center');
					},
					start: function(e, pageObj) {},
					end: function(e, pageObj) {
						var book = $(this);
						updateDepth(book);
						IEcss();
					},
					missing: function(e, pages) {
						for (var i = 0; i < pages.length; i++) {
							addPage(bookIdx, pages[i], $(this));
						}
					}
				}
			});

			flipbook.addClass('animated');

			if (!$.os.mobile) {
				$('.flipbook_nextpage_btn').bind($.mouseEvents.down, function() {
					$(this).addClass('next-button-down');
				}).bind($.mouseEvents.up, function() {
					$(this).removeClass('next-button-down');
				}).click(function() {
					flipbook.turn('next');
				});
				$('.flipbook_prevpage_btn').bind($.mouseEvents.down, function() {
					$(this).addClass('previous-button-down');
				}).bind($.mouseEvents.up, function() {
					$(this).removeClass('previous-button-down');
				}).click(function() {
					flipbook.turn('previous');
				});
			} else {
				$('.flipbook_nextpage_btn').on('touchend', function() {
					flipbook.turn('next');
				});
				$('.flipbook_prevpage_btn').on('touchend', function() {
					flipbook.turn('previous');
				});
			}

			function bookLength() {
				var length = $('.flipbook_wrapper').attr('pagecount');
				if (length % 2 != 0) {
					return parseInt(length) + 1;
				} else {
					return length;
				}
				return length;
			}

			function getViewNumber(book, page) {
				return parseInt((page || book.turn('page')) / 2 + 1, 10);
			}

			function getViewNumber(book, page) {
				return parseInt((page || book.turn('page')) / 2 + 1, 10);
			}

			function isChrome() {
				return navigator.userAgent.indexOf('Chrome') != -1;
			}

			function loadPage(bookIdx, page) {
				$.ajax({
					url: 'flipbookpages/' + bookIdx + '/page' + page + '.html'
				}).done(function(pageHtml) {
					$('.flipbook .p' + page).html(pageHtml.replace('yb3.0/flipbookpages/', ''));
				});
			}

			function addPage(bookIdx, page, book) {
				var pages = book.turn('pages');
				if (!book.turn('hasPage', page)) {
					var element = $('<div />', {
						'class': 'own-size',
						css: {
							width: 395,
							height: 560,
						}
					}).html('<div class="loader"></div>');
					if (book.turn('addPage', element, page)) {
						loadPage(bookIdx, page);
					}
				}
			}

			function updateDepth(book, newPage) {
				var page = book.turn('page'),
					pages = bookLength(),
					depthWidth = 20 * Math.min(1, (pages - (pages - page)) / pages);
				newPage = newPage || page;

                if (newPage > 3) {
                    $('.flipbook-viewport .p2 .depth').css({
                        width: depthWidth,
                        left: 12 - depthWidth,
                        'z-index': 1
                    });
                } else {
                    $('.flipbook-viewport .p2 .depth').css({
                        width: 0,
                        'z-index': 1
                    });
                }
                depthWidth = 30 * Math.min(1, (pages - page) / pages);
                if (newPage < pages - 3) {
                    $('.flipbook-viewport .p' + (pages - 1) + ' .depth').css({
                        width: depthWidth,
                        right: 12 - depthWidth,
                        'z-index': 1
                    });
                } else {
                    $('.flipbook-viewport .p' + (pages - 1) + ' .depth').css({
                        width: 0,
                        'z-index': 1
                    });
                }
            }

			function disableControls(page) {
				$('.flipbook_nextpage_btn').css({
					'background-color': 'rgba(0,0,0,0.1)',
					'background-position': '-40px 280px'
				});
				$('.flipbook_prevpage_btn').css({
					'background-color': 'rgba(0,0,0,0.1)',
					'background-position': '0 280px'
				})
				if (page == 1) {
					$('.flipbook_prevpage_btn').hide();
					$('.flipbook_nextpage_btn').show().css({
						right: 164,
					});
				} else if (page == $('.flipbook').turn('pages')) {
					var length = $('.flipbook .page-wrapper').length;
					$('.flipbook_prevpage_btn').show().css({
						left: 180
					});
					$('.flipbook_nextpage_btn').hide();
				} else {
					$('.flipbook_prevpage_btn').show().css({
						left: '-26px'
					});
					$('.flipbook_nextpage_btn').show().css({
						right: '-39px'
					});
				}
			}

			function IEcss(argu){
				if (window.ActiveXObject || 'ActiveXObject' in window) {
					$('.flipbook-viewport .secondcover>div').css({
						left: 13
					});
				}
			}
		}
		// Load the HTML4 version if there's not CSS transform
		yepnope({
			test: Modernizr.csstransforms,
			yep: ['assets/js/turn.js'],
			nope: ['assets/js/turn.html4.min.js'],
			complete: loadApp
		});
	</script>
</body>

</html>
