<!DOCTYPE html>
<html>

<head lang="ch">
	<meta charset="UTF-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" id="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge，chrome=1">
	<title>忆尔3.9-书册预览</title>
	<!-- build:css ../css/m.all.min.css -->
	<link rel="stylesheet" href="../css/m_reset.css" type="text/css" />
	<link rel="stylesheet" href="../css/m_common.css" type="text/css" />
	<link rel="stylesheet" href="../css/m_bookpreview.css" type="text/css" />
	<!-- endbuild -->

	<link rel="stylesheet" href="../assets/css/font-awesome.css" type="text/css" />
	<link rel="stylesheet" href="../assets/css/bootstrap-switch.min.css" type="text/css" media="all" />
</head>

<body>
	<div class='main_container'>
		<!--竖屏class:bp_con_v has_footer_nav，横屏class:bp_con_h-->
		<div class="bp_tpl">
			<div class="ybwechatheader_wrapper">
				<a class='left_btn back_btn' href="javascript:;"></a>
				<p>
					<span class="tips">提示：将手机横屏可进行全屏预览</span>
					<span class="cur_page">1/33</span>
				</p>
				<a class='right_btn share_btn' href="javascript:;"></a>
			</div>
			<div class="flipbook-viewport">
				<div class='flipbook_wrapper' pagecount='19'>
					<a class='flipbook_prevpage_btn' href="javascript:;"></a>

					<div class='flipbook'>
						<div depth="5" class="hard" style="background-image:url('../img/pages/1.jpg');">
							<link href="http://yb-test-book.qiniudn.com/pageTpl/IMAGE_TEXT/37/css/small_left.css" rel="stylesheet" type="text/css">
							<div class="container_activity_37_small_left">
								<div class="page_header_container">
									<div slottype="article" class="warp1">
										<div class="richShow" slottype="articleShow" textheight="40">
											<div class="main_title" slottype="richText" slotnum="0">
												雄关为头越
											</div>
										</div>
									</div>
								</div>
								<div class="photo0_container">
									<span id="imgMask0" imgwidth="1324" imgheight="907" slotnum="0" slottype="mask" class="photoframe_common_property photoframe0"></span>
									<img slottype="img" slotnum="0" class="img0" src="">
								</div>
								<div class="photo1_container">
									<span id="imgMask1" imgwidth="498" imgheight="334" slotnum="1" slottype="mask" class="photoframe_common_property photoframe1"></span>
									<img slottype="img" slotnum="1" class="img1" src="">
								</div>
								<div class="photo2_container">
									<span id="imgMask2" imgwidth="389" imgheight="261" slotnum="2" slottype="mask" class="photoframe_common_property photoframe2"></span>
									<img slottype="img" slotnum="2" class="img2" src="">
								</div>
								<div class="content_container">
									<strong>
									<div slottype="article" class="warp2">
										<div class="richShow" slottype="articleShow" textheight="30">
											<p></p>

											<p slottype="richText" slotnum="2" style="min-height:30px;"
											   placeholder="活动标题" mode="inline"></p>

											<p></p>
										</div>
									</div>
								</strong>

									<div slottype="article" class="warp3">
										<div class="richShow" slottype="articleShow" textheight="96">
											<p slottype="richText" slotnum="3" style="display:block;word-wrap:break-word;" placeholder="活动内容"></p>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div depth="5" class="hard front-side secondcover even" style="background-image:url('../img/pages/2.jpg');">
							<span class="depth"></span>
							<link href="http://yb-test-book.qiniudn.com/pageTpl/PANO/2/css/small_left.css" rel="stylesheet" type="text/css">
							<div class="container_panoramic_02_small_left">
								<div slottype="article" class="warp">
									<div slottype="articleShow" textheight="62" class="richShow">
										<p placeholder="学校班级.." slottype="richText" slotnum="4" mode="inline" class="graduate-po">
										</p>
									</div>
								</div>
								<span id="imgMask1" imgwidth="3120" imgheight="1700" slotnum="1" slottype="mask" class="photoframe1" style="text-align:center;vertical-align:middle;display: block;"></span>
								<img slottype="img" slotnum="1" src="" class="img1">
							</div>
						</div>
						<div class="hard fixed back-side thirdcover p19" style="background-image:url('../img/pages/tpl_small.jpg')">
							<span class="depth"></span>
							<link href="http://yb-test-book.qiniudn.com/pageTpl/PANO/2/css/small_right.css" rel="stylesheet" type="text/css">
							<div class="container_panoramic_02_small_right">
								<div slottype="article" class="warp">
									<div slottype="articleShow" textheight="62" class="richShow">
										<p placeholder="学校班级.." slottype="richText" slotnum="4" mode="inline" class="graduate-po">
										</p>
									</div>
								</div>
								<span id="imgMask1" imgwidth="3120" imgheight="1700" slotnum="1" slottype="mask" class="photoframe1" style="text-align:center;vertical-align:middle;display: block;"></span>
								<img slottype="img" slotnum="1" src="" class="img1">
							</div>
						</div>
						<div class="hard p20" style="background-image:url('../img/pages/tpl_small.jpg')"></div>
					</div>
					<a class='flipbook_nextpage_btn' href="javascript:;"></a>
				</div>
			</div>
		</div>
		<div class="vsub">
			<div class="tpl_info">本书一共有<span>XX</span>页，可上传<span>XX</span>张照片</div>
			<div class="htool_wrap">
				<div class="hd">
					<ul>
						<li>
							<a href="javascript:;">
								<div class="comment"></div>
								<p>评论(<span>123</span>)</p>
							</a>
						</li>
						<li>
							<a href="javascript:;">
								<div class="barrage_switch">
									<input type="checkbox" />
								</div>
								<p>弹幕开关</p>
							</a>
						</li>
						<li>
							<a href="javascript:;">
								<div class="praise"></div>
								<p>被赞(<span>123</span>)</p>
							</a>
						</li>
					</ul>
				</div>
				<div class="bd">
					<div class="comment_con ">
						<span class="up_arrow"></span>
						<table>
							<tr>
								<td>
									<div class="user_header"><img src="../img/m/user_default_head.png"></div>
								</td>
								<td>
									<div class="user_name"><span>username</span></div>
								</td>
								<td>
									<div class="commet_time"><span>2015-12-31</span></div>
								</td>
							</tr>
							<tr>
								<td colspan="3" class="">
									<p>说些什么什么事什么什么事没什么事忙什么什么事...</p>
								</td>
							</tr>
						</table>
						<table>
							<tr>
								<td>
									<div class="user_header"><img src="../img/m/user_default_head.png"></div>
								</td>
								<td>
									<div class="user_name"><span>username</span></div>
								</td>
								<td>
									<div class="commet_time"><span>2015-12-31</span></div>
								</td>
							</tr>
							<tr>
								<td colspan="3" class="">
									<p>说些什么什么事什么什么事没什么事忙什么什么事...</p>
								</td>
							</tr>
						</table>
						<div class="ybwechat_loading_item">
							<a href="javascript:;">查看更多评论（<span>22</span>）</a>
						</div>
					</div>
					<div class="praise_con">
						<span class="up_arrow"></span>
						<ul>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">username</p>
							</li>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">usernameusername</p>
							</li>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">username</p>
							</li>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">username</p>
							</li>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">username</p>
							</li>
							<li>
								<div class="user_header">
									<img src="../img/m/user_default_head.png">
								</div>
								<p class="user_name">username</p>
							</li>
						</ul>
					</div>
					<div class="comment_msg"></div>
				</div>
			</div>
			<div class="comment_input">
				<div class="input_box">
					<input id="reply-write" type="text" placeholder="这里输入聊天内容" />
					<button type="button" onclick="sendComment();"><i></i></button>
				</div>
			</div>
		</div>
		<div class="hsub">
			<ul>
				<li>
					<a href="javascript:;">
						<div class="comment"></div>
						<p>评论</p>
					</a>
				</li>
				<li>
					<a href="javascript:;">
						<div class="praise"></div>
						<p>被赞</p>
					</a>
				</li>
				<li>
					<a href="javascript:;">
						<div class="share"></div>
						<p>分享</p>
					</a>
				</li>
				<li>
					<a href="javascript:;">
						<div class="barrage_switch">
							<input type="checkbox" data-size="mini" />
						</div>
						<p>弹幕</p>
					</a>
				</li>
			</ul>
			<div class="cm_fr chapter_slide">
				<a href="javascript:;">上一章节</a>
				<a href="javascript:;">下一章节</a>
			</div>
		</div>
	</div>
	<script src="../assets/js/jquery.min.js"></script>
	<!--<script src="../assets/js/modernizr.2.5.3.min.js"></script>-->
	<!--<script src="../assets/js/zepto.min.js"></script>-->
	<script type="text/javascript" src="../assets/js/jquery.mobile.custom.min.js"></script>
	<script type="text/javascript" src="../assets/js/turn.js"></script>
	<script type="text/javascript" src="../assets/js/bootstrap-switch.min.js"></script>
	<script type="text/javascript" src='../js/check_os.js'></script>
	<script>
		var LOG = function() {
			return;
		};
		var LOG = alert;
		$(function() {
			loadApp();
			barrageSwitch();
			CommentPraiseTab();
			showBookToolWrap();
			orientationEventTrigger();

		});

		function orientationEventTrigger() {
			var flipbookWidth = 0;
			window.currentPage = 1;
			var windowWidth = $(window).width(),
				windowHeight = $(window).height();
			orientationSensor({
				portrait: function() {
					portraitHandler(windowWidth, windowHeight);
				},
				landscape: function() {
					landscapeHandler(windowHeight);
				}
			});

			$(window).on("orientationchange", function(event) {
				var windowWidth = $(window).width(),
					windowHeight = $(window).height();
				orientationHandler(event, {
					portrait: function() {
						portraitHandler(windowWidth, windowHeight);
					},
					landscape: function() {
						landscapeHandler(windowHeight);
					}
				});
			});
			return flipbookWidth;
		}

		//屏幕方向探测器
		function orientationSensor(callback) {
			var windowWidth = $(window).width(),
				windowHeight = $(window).height();
			if (typeof(callback) == 'undefined') {
				callback = {
					portrait: function() {},
					landscape: function() {}
				}
			} else {
				if (windowWidth < windowHeight) {
					return callback.portrait();
				} else {
					return callback.landscape();
				}
			}
		}
		//方向判断回调工具
		function orientationHandler(event, callback) {
			if (typeof(callback) == 'undefined') {
				callback = {
					portrait: function() {},
					landscape: function() {}
				}
			};
			switch (event.orientation) {
				case 'portrait':
					callback.portrait();
					console.log("方法改变为：" + event.orientation);
					break;
				case 'landscape':
					callback.landscape();
					console.log("方法改变为：" + event.orientation);
					break;
				default:
					LOG('default');
			}
			return callback;
		}

		// 竖屏控制器
		function portraitHandler(windowWidth, windowHeight) {
			$('.flipbook-viewport').css({
				'height': windowWidth * 0.5
			});
			$(".flipbook").turn("destroy");
			flipbookWidth = 1360 * (windowWidth / 1360) * 0.7;
			turnInit(window.currentPage);
			LOG(window.currentPage);
		}
		// 横屏控制器
		function landscapeHandler(windowHeight) {
			$('.flipbook-viewport').css({
				'height': windowHeight
			});
			$(".flipbook").turn("destroy");
			flipbookWidth = 1360 * (windowHeight / 964) * 0.87;
			turnInit(window.currentPage);
			LOG(window.currentPage);
		}
		// 书册大小重定义
		function flipbookResize() {
			var zoom = 0,
				windowWidth = $(window).width(),
				windowHeight = $(window).height(),
				originalWidth = 680,
				originalHeight = 964,
				portraitFactor = 0.7,
				landscapeFactor = 0.87;
			orientationSensor({
				portrait: function() {
					var zoom = windowWidth / (originalWidth * 2) * portraitFactor;
					$('.flipbook .page>div').css(sizeArguObj(zoom));
					console.log(zoom);
				},
				landscape: function() {
					var zoom = windowHeight * landscapeFactor / originalHeight;
					$('.flipbook .page>div').css(sizeArguObj(zoom));
					console.log(zoom);
				}
			});
			// 尺寸设定集
			function sizeArguObj(zoom) {
				return {
					'-ms-zoom': zoom,
					'-webkit-transform': 'scale(' + zoom + ')',
					'-webkit-transform-origin': 'left top',
					'-moz-transform': 'scale(' + zoom + ')',
					'-moz-transform-origin': 'left center'
				}
			}
		}

		function turnInit(currentPage) {
			var bookIdx = 2,
				windowWidth = $(window).width(),
				windowHeight = $(window).height(),
				pageWidth = $('.flipbook-viewport .page').width(),
				pageHegiht = $('.flipbook-viewport .page').height(),
				flipbook = $('.flipbook'),
				zoom = 0,
				flipbookWidth = orientationSensor({
					portrait: function() {
						return 1360 * (windowWidth / 1360) * 0.7;
					},
					landscape: function() {
						return 1360 * (windowHeight / 964) * 0.87;
					}
				});

			flipbook.turn({
				width: flipbookWidth,
				height: flipbookWidth * 0.7,
				elevation: 0,
				acceleration: !isChrome(),
				autoCenter: true,
				gradients: true,
				duration: 1000,
				pages: bookLength(),
				when: {
					first: function() {
						$('.page-wrapper').find('.p1').addClass('hard');
					},
					turning: function(e, page, view) {
						var book = $(this),
							pages = book.turn('pages');
						window.currentPage = book.turn('page');
						// $('.page-wrapper .page').addClass('hard')

						if (window.currentPage > 3 && window.currentPage < pages - 3) {
							if (page == 1) {
								book.turn('page', 2).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							} else if (page == pages) {
								book.turn('page', pages - 1).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							}
						} else if (page > 3 && page < pages - 3) {
							if (window.currentPage == 1) {
								book.turn('page', 2).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							} else if (window.currentPage == pages) {
								book.turn('page', pages - 1).turn('stop').turn('page', page);
								e.preventDefault();
								return;
							}
						}

						disableControls(page);

						if (page >= 2) {
							$('.flipbook_wrapper .p2').addClass('fixed');
						} else {
							$('.flipbook_wrapper .p2').removeClass('fixed');
						}
						if (page < book.turn('pages')) {
							$('.flipbook_wrapper .p' + (bookLength() - 1)).addClass('fixed');
						} else {
							$('.flipbook_wrapper .p' + (bookLength() - 1)).removeClass('fixed');
						}

					},
					turned: function(e, page, view) {
						var book = $(this);
						disableControls(page);
						book.turn('center');
						window.currentPage = flipbook.turn('page');
						// LOG(window.currentPage)
					},
					start: function(e, pageObj) {},
					end: function(e, pageObj) {
						var book = $(this);
						flipbookResize();
					},
					missing: function(e, pages) {
						for (var i = 0; i < pages.length; i++) {
							addPage(bookIdx, pages[i], $(this), flipbookWidth);
						}
					}
				}
			});
			$('.flipbook_wrapper').css({
				width: flipbookWidth
			});

			flipbook.addClass('animated');

			$('.flipbook_nextpage_btn').on('touchend', function() {
				flipbook.turn('page', window.currentPage + 2);
			});
			$('.flipbook_prevpage_btn').on('touchend', function() {
				flipbook.turn('page', window.currentPage - 2);
			});

			setTimeout(function() {
				flipbookResize();
			}, 50)


			function isChrome() {
				return navigator.userAgent.indexOf('Chrome') != -1;
			}

			function bookLength() {
				var length = $('.flipbook_wrapper').attr('pagecount');
				if (length % 2 != 0) {
					return parseInt(length) + 1;
				} else {
					return length;
				}
			}

			function addPage(bookIdx, page, book, flipbookWidth) {
				var pages = book.turn('pages');
				if (!book.turn('hasPage', page)) {
					var element = $('<div />', {
						'class': 'own-size',
						css: {
							width: flipbookWidth / 2,
							height: flipbookWidth * 0.7
						}
					}).html('<div class="loader"></div>');
					if (book.turn('addPage', element, page)) {
						loadPage(bookIdx, page);
					}
				}

				function loadPage(bookIdx, page) {
					$.ajax({
						url: '../flipbookpages/' + bookIdx + '/page' + page + '.html'
					}).done(function(pageHtml) {
						$('.flipbook .p' + page).html(pageHtml.replace('yb3.0/flipbookpages/', ''));
					});
				}
			}

			function disableControls(page) {
				var prevBtn = $('.flipbook_prevpage_btn'),
					nextBtn = $('.flipbook_nextpage_btn')
				if (page == 1) {
					prevBtn.hide();
					nextBtn.show();
				} else if (page == flipbook.turn('pages')) {
					prevBtn.show();
					nextBtn.hide();
				} else {
					prevBtn.show();
					nextBtn.show();
				}
			}

		}

		function loadApp() {
			//这是指定当前读取的是第几本书册的变量，序号是flipbookpages文件夹里的序号
			var bookIdx = 2,
				windowWidth = $(window).width(),
				windowHeight = $(window).height(),
				pageWidth = $('.flipbook-viewport .page').width(),
				pageHegiht = $('.flipbook-viewport .page').height(),
				flipbook = $('.flipbook'),
				zoom = 0,
				flipbookWidth = orientationSensor({
					portrait: function() {
						return 1360 * (windowWidth / 1360) * 0.7;
					},
					landscape: function() {
						return 1360 * (windowHeight / 964) * 0.87;
					}
				});
			turnInit();
			flipbookResize();

		}


		/*
		 * 评论赞tab切换
		 * */
		function CommentPraiseTab() {
			$('.htool_wrap .hd a').on('touchend', function() {
				switch ($(this).closest('li').index()) {
					case 0:
						$('.bd .comment_con').show();
						$('.bd .praise_con').hide();
						break;
					case 1:
						return
					case 2:
						$('.bd .comment_con').hide();
						$('.bd .praise_con').show();
				}
			})
		}

		/*
		 * 弹幕开关
		 * */
		function barrageSwitch() {
			$(".barrage_switch input[type=checkbox]").bootstrapSwitch({
				onColor: 'success',
				onSwitchChange: function(e, state) {
					if (state) {
						$(".comment_msg").show();
						init_screen();
					} else {
						$(".comment_msg").hide().find('div').remove();
					}
				}
			});

			$('.hsub input[type=checkbox]').bootstrapSwitch({
				onColor: 'success',
				size: 'mini',
				onSwitchChange: function(e, state) {
					if (state) {
						$(".comment_msg").show();
						init_screen();
					} else {
						$(".comment_msg").hide().find('div').remove();
					}
				}
			});
		}


		/*
		 * 发射弹幕
		 * */
		function sendComment() {
			$('.comment_input button').on('touchend', function() {
				var content = $("#reply-write").val();
				if ($.trim(content) == "") {
					LOG("亲，请输入你的想说的话！");
					return false;
				}

				var text = $("#reply-write").val();
				var div = "<div><p>" + text + "</p></div>";
				$('.comment_msg div').last().css({
					'color': getReandomColor(),
					'font-size': getReandomFontSize()
				});
				$("#reply-write").val("");
				$(".comment_msg").append(div);
				init_screen();
			});

			//多久请求一下数据库
			setInterval("startRequest()", 10000);

			function startRequest() {
				html = "<div><p>感谢你，啦啦啦</p></div>";
				html += "<div><p>嗯嗯嗯爱爱爱爱啊</p></div>";
				html += "<div><p>我的天呀</p></div>";
				html += "<div><p>good good good </p></div>";
				html += "<div><p>O(∩_∩)O哈哈哈~</p></div>";
				html += "<div><p>嗯嗯嗯爱爱爱爱啊</p></div>";
				html += "<div><p>我的天呀</p></div>";
				html += "<div><p>good good good </p></div>";
				html += "<div><p>嗯嗯嗯爱爱爱爱啊</p></div>";
				html += "<div><p>我的天呀</p></div>";
				html += "<div><p>good good good</p> </div>";

				$(".comment_msg").append(html);
				var num = $(".comment_msg").find("div").length;
				if (num > 30) {
					$(".comment_msg").find("div:lt(20)").remove();
				}
				for (var i = 0; i < num; i++) {
					$(".comment_msg").find("div").eq(i).css({
						'color': getReandomColor(),
						'font-size': getReandomFontSize()
					});
				}
				init_screen();


				//随机获取颜色值
				function getReandomColor() {
					return '#' + (function(h) {
						return new Array(7 - h.length).join("0") + h
					})((Math.random() * 0x1000000 << 0).toString(16))
				}

				//随机获取字号
				function getReandomFontSize() {
					return (function() {
						return Math.floor(Math.random() * (45 - 12 + 1) + 12) + 'px';
					});
				}
			}
		}

		function init_screen() {
			var _top = 0;
			$(".comment_msg").find("div").show().each(function() {
				var _left = $(window).width() - $(this).width() + 220;
				var _height = $(window).height() + 100;

				_top = _top + 36;
				if (_top >= _height - 120) {
					_top = 40;
				}
				$(this).css({
					left: _left,
					top: _top
				});
				var time = 10000;
				if ($(this).index() % 2 == 0) {
					time = 12000;
				}
				if ($(this).index() % 3 == 0) {
					time = 14000;
				}
				if ($(this).index() % 4 == 0) {
					time = 16000;
				}
				if ($(this).index() % 5 == 0) {
					time = 18000;
				}
				if ($(this).index() % 7 == 0) {
					time = 20000;
				}
				if ($(this).index() % 8 == 0) {
					time = 23000;
				}
				$(this).animate({
					left: "-" + _left + "px"
				}, time, function() {});
			});
		}


		/*
		 * click title and footer tooltip
		 * */
		function showBookToolWrap() {
			$('.bp_tpl_h').on("click", function() {
				$('.ybwechatheader_wrapper').toggle();
				$('.hsub').toggle();
			});
		}
	</script>
</body>

</html>
